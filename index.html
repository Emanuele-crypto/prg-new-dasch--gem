```html
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programma Giornaliero Trasformazione Frutta - Simone Gatto</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
* {
   margin: 0;
   padding: 0;
   box-sizing: border-box;
}

body { 
   font-family: 'Arial', sans-serif;
   font-size: 18px;
   line-height: 1.4;
   color: #000000;
   margin: 20px;
   background-color: #f5f5f5;
}

.header {
   text-align: center;
   margin-bottom: 20px;
   background: #1e3c72;
   border: 2px solid #000000;
   padding: 15px;
   border-radius: 8px;
   color: #ffffff;
}

.header h1 {
   font-size: 24px;
   margin-bottom: 8px;
   font-weight: bold;
   color: #ffffff;
}

.header .subtitle {
   font-size: 20px;
   margin-bottom: 8px;
   color: #ffffff;
}

.header-info {
   display: flex;
   justify-content: space-around;
   margin-top: 10px;
   font-size: 17px;
   color: #ffffff;
}

.controls-section {
   background-color: #e9ecef;
   border: 1px solid #000000;
   border-radius: 5px;
   padding: 15px;
   margin-bottom: 20px;
   display: flex;
   gap: 20px;
   align-items: center;
   flex-wrap: wrap;
}

.controls-section .form-group {
   display: flex;
   flex-direction: column;
   min-width: 200px;
}

.controls-section label {
   font-weight: bold;
   margin-bottom: 5px;
   color: #000000;
}

.controls-section .form-control,
.controls-section .form-select {
   border: 1px solid #000000;
   border-radius: 4px;
   padding: 8px;
   font-size: 16px;
}

.btn {
   padding: 10px 20px;
   border: none;
   border-radius: 5px;
   font-weight: bold;
   cursor: pointer;
   text-decoration: none;
   display: inline-block;
   margin: 5px;
}

.btn-primary {
   background: #1e3c72;
   color: white;
}

.btn-primary:hover {
   background: #2a5298;
   color: white;
}

.btn-success {
   background: #28a745;
   color: white;
}

.btn-success:hover {
   background: #20c997;
   color: white;
}

.btn-warning {
   background: #ffc107;
   color: #000000;
}

.btn-warning:hover {
   background: #ffb300;
   color: #000000;
}

.btn-danger {
   background: #dc3545;
   color: white;
}

.btn-danger:hover {
   background: #c82333;
   color: white;
}

.btn-info {
   background: #17a2b8;
   color: white;
}

.btn-info:hover {
   background: #138496;
   color: white;
}

.totals-section {
   display: grid;
   grid-template-columns: repeat(3, 1fr);
   gap: 10px; /* Reduced gap */
   margin-bottom: 20px;
   background-color: #ffc107; /* Ocher yellow */
   padding: 10px; /* Reduced padding */
   border: 1px solid #000000;
   border-radius: 5px;
}

.total-item {
   text-align: center;
   color: #000000;
   background-color: #ffe08a; /* Lighter ocher yellow */
   border-radius: 5px;
   padding: 5px; /* Reduced padding */
   height: 60px; /* Compacted height */
   display: flex;
   flex-direction: column;
   justify-content: center;
}

.total-value {
   font-size: 20px; /* Slightly reduced font size */
   font-weight: bold;
   color: #000000;
}

.total-label {
   font-size: 14px; /* Slightly reduced font size */
   margin-top: 3px;
   color: #000000;
}

.suppliers-container {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
   gap: 15px;
   margin-bottom: 20px;
}

.supplier-card {
   background-color: #e9ecef;
   border: 1px solid #000000;
   border-radius: 5px;
   padding: 15px;
   page-break-inside: avoid;
}

.supplier-header {
   background: #6c757d;
   color: #ffffff;
   padding: 8px;
   text-align: center;
   font-weight: bold;
   font-size: 20px;
   margin: -15px -15px 15px -15px;
   border-bottom: 1px solid #000000;
}

.form-row {
   display: flex;
   justify-content: space-between;
   margin-bottom: 8px;
   align-items: center;
}

.form-label {
   font-weight: bold;
   color: #000000;
   width: 45%;
   font-size: 16px;
}

.form-input {
   width: 53%;
}

.form-input input,
.form-input select,
.form-input textarea {
   width: 100%;
   border: 1px solid #000000;
   border-radius: 4px;
   padding: 6px;
   font-size: 14px;
}

.form-input textarea {
   min-height: 60px;
   resize: vertical;
}

.calculated-field {
   background-color: #e7f3ff;
   font-weight: bold;
   text-align: center;
}

.yield-result {
   background-color: #e8f5e8;
   font-weight: bold;
   text-align: center;
}

.bio-red-field {
   color: #dc3545 !important;
   font-weight: bold;
   border-color: #dc3545 !important;
}

.bio-black-field {
   color: #000000 !important;
   font-weight: bold;
   border-color: #495057 !important;
}

.bio-red-text {
   color: #dc3545 !important;
   font-weight: bold;
}

.bio-black-text {
   color: #000000 !important;
   font-weight: bold;
}

.combination-result {
   background-color: #fff3cd !important;
   border: 2px solid #ffc107 !important;
   font-weight: bold;
   color: #856404 !important;
}

.auto-sum-field {
   background-color: #fffacd !important;
   border: 2px solid #ffd700 !important;
   font-weight: bold;
}

.received-transfer {
   background-color: #d4edda !important;
   border: 2px solid #28a745 !important;
}

.section-divider {
   border-bottom: 1px solid #6c757d;
   margin: 8px 0;
}

/* Combination colors */
.supplier-card.combination-green {
    background-color: #e6ffe6; /* Light green */
    border-color: #28a745; /* Green */
}
.supplier-card.combination-blue {
    background-color: #e6f7ff; /* Light blue */
    border-color: #17a2b8; /* Blue */
}
.supplier-card.combination-purple {
    background-color: #f3e6ff; /* Light purple */
    border-color: #6f42c1; /* Purple */
}

.supplier-card.combination-green .supplier-header {
    background-color: #28a745; /* Green */
}
.supplier-card.combination-blue .supplier-header {
    background-color: #17a2b8; /* Blue */
}
.supplier-card.combination-purple .supplier-header {
    background-color: #6f42c1; /* Purple */
}


.summary-section {
   display: flex;
   gap: 20px;
   margin-top: 20px;
}

.summary-box {
   flex: 1;
   background: #ffc107;
   padding: 15px;
   border: 1px solid #000000;
   border-radius: 5px;
   color: #000000;
}

.summary-title {
   font-weight: bold;
   font-size: 20px;
   margin-bottom: 10px;
   text-align: center;
   color: #000000;
}

.summary-item {
   display: flex;
   justify-content: space-between;
   margin-bottom: 5px;
   font-size: 17px;
   color: #000000;
}

.summary-value {
   font-weight: bold;
   font-size: 18px;
   color: #000000;
}

.summary-input {
   width: 100%;
   border: 1px solid #000000;
   border-radius: 4px;
   padding: 6px;
   font-size: 14px;
   margin-top: 5px;
}

.summary-textarea {
   width: 100%;
   border: 1px solid #000000;
   border-radius: 4px;
   padding: 6px;
   font-size: 14px;
   min-height: 60px;
   resize: vertical;
   margin-top: 5px;
}

.footer {
   text-align: center;
   margin-top: 20px;
   font-size: 16px;
   color: #000000;
   background-color: #e9ecef;
   padding: 10px;
   border: 1px solid #000000;
   border-radius: 5px;
}

.transfer-details, .distribution-details {
   font-size: 15px;
   color: #000000;
   margin-top: 5px;
   background-color: #d4edda;
   padding: 5px;
   border-radius: 3px;
   border: 1px solid #28a745;
}

.hidden-field {
   display: none;
}

.yields-modal {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background-color: rgba(0,0,0,0.5);
   display: none;
   z-index: 1000;
   overflow-y: auto;
}

.yields-content {
   position: relative;
   background-color: white;
   margin: 2% auto;
   padding: 20px;
   width: 90%;
   max-width: 1200px;
   min-height: 80%;
   border-radius: 15px;
}

.yields-header {
   background: linear-gradient(135deg, #1e3c72, #2a5298);
   color: white;
   padding: 20px;
   border-radius: 10px;
   margin-bottom: 20px;
   display: flex;
   justify-content: space-between;
   align-items: center;
}

.close-yields {
   color: white;
   font-size: 28px;
   font-weight: bold;
   cursor: pointer;
}

.close-yields:hover {
   color: #f0f0f0;
}

.yields-table {
   width: 100%;
   border-collapse: collapse;
   margin-top: 20px;
}

.yields-table th {
   background-color: #1e3c72;
   color: white;
   padding: 12px 8px;
   text-align: center;
   font-weight: 600;
   border: 1px solid #dee2e6;
   font-size: 12px;
}

.yields-table td {
   padding: 8px;
   text-align: center;
   border: 1px solid #dee2e6;
   vertical-align: middle;
}

.yields-table td:first-child {
   background-color: #f8f9fa;
   font-weight: 600;
   width: 120px;
}

.yields-table input[type="number"] {
   width: 70px;
   padding: 6px;
   border: 1px solid #ddd;
   border-radius: 4px;
   text-align: center;
   font-size: 12px;
}

.yields-section {
   margin-bottom: 30px;
   background-color: #f8f9fa;
   padding: 20px;
   border-radius: 10px;
   border-left: 4px solid #2a5298;
}

.agrume-display {
   background-color: #e7f3ff;
   border: 2px solid #2a5298;
   border-radius: 8px;
   padding: 15px;
   text-align: center;
   margin-bottom: 20px;
}

.select2-container {
   width: 100% !important;
}

.select2-container--default .select2-selection--multiple {
   border: 1px solid #000000;
   border-radius: 4px;
   min-height: 35px;
   padding: 2px;
}

.distribution-section {
   margin-top: 10px;
   padding: 10px;
   border: 1px solid #17a2b8;
   border-radius: 5px;
   background-color: #f8f9fa;
}

.distribution-row {
   display: flex;
   align-items: center;
   margin-bottom: 5px;
   gap: 5px;
}

.distribution-dest {
   flex: 1;
   font-weight: bold;
   color: #17a2b8;
   font-size: 14px;
}

.distribution-qty {
   width: 80px;
}

.remaining-qty {
   background-color: #e7f3ff;
   border: 1px solid #2a5298;
   padding: 5px;
   border-radius: 3px;
   font-weight: bold;
   text-align: center;
   color: #1e3c72;
   font-size: 14px;
   margin-bottom: 10px;
}

.transfer-section {
   background-color: #fff3cd;
   border: 1px solid #ffc107;
   border-radius: 5px;
   padding: 8px;
   margin-top: 8px;
}

.transfer-row {
   display: flex;
   align-items: center;
   gap: 5px;
   flex-wrap: wrap;
}

.transfer-row .form-label {
   min-width: 80px;
   margin-bottom: 0;
   font-size: 12px;
   flex-shrink: 0;
}

.transfer-row .transfer-destination {
   min-width: 120px;
   flex: 1;
   font-size: 12px;
}

.transfer-row .transfer-qty {
   width: 50px;
   font-size: 12px;
}

.transfer-row .btn {
   padding: 4px 8px;
   font-size: 11px;
   margin: 0;
   white-space: nowrap;
}

.combination-section {
   background-color: #e9ecef; /* Light gray */
   border: 1px solid #000000;
   border-radius: 5px;
   padding: 15px;
   margin-bottom: 20px;
}

.combination-group {
   display: flex;
   align-items: center;
   gap: 10px;
   margin-bottom: 10px;
   padding: 10px;
   border: 2px solid #8e8e8e; /* Darker gray border */
   border-radius: 8px;
   background-color: #f8f8f8; /* Very light gray */
}

.combination-group.combination-green-bg {
    background-color: #e6ffe6;
    border-color: #28a745;
}
.combination-group.combination-blue-bg {
    background-color: #e6f7ff;
    border-color: #17a2b8;
}
.combination-group.combination-purple-bg {
    background-color: #f3e6ff;
    border-color: #6f42c1;
}

.combination-group h5 {
   margin-bottom: 0;
   min-width: 150px;
}

.combination-group .form-select {
   flex-grow: 1;
}

.combination-group .btn {
   margin-left: 0;
   margin-right: 0;
}

@media print {
   body { 
       margin: 15mm;
       background-color: #ffffff;
       font-size: 16px;
   }
   
   .controls-section {
       display: none !important;
   }
   
   .combination-section {
       display: none !important;
   }
   
   .btn {
       display: none !important;
   }
   
   .suppliers-container {
       grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
   }
   
   .header {
       background: #1e3c72 !important;
       color: #ffffff !important;
   }
   
   .header h1, .header .subtitle, .header-info {
       color: #ffffff !important;
   }
   
   .total-value, .total-label {
       color: #000000 !important;
   }
   
   .supplier-header {
       background: #6c757d !important;
       color: #ffffff !important;
   }
   
   .bio-red-field {
       color: #dc3545 !important;
   }
   
   .bio-black-field {
       color: #000000 !important;
   }
   
   .bio-red-text {
       color: #dc3545 !important;
   }
   
   .bio-black-text {
       color: #000000 !important;
   }
   
   @page {
       margin: 10mm;
       size: A4 landscape;
   }
}

.save-status {
   background-color: #d4edda;
   border: 1px solid #28a745;
   color: #155724;
   padding: 10px;
   border-radius: 5px;
   margin-bottom: 20px;
   text-align: center;
   display: none;
}

.save-error {
   background-color: #f8d7da;
   border: 1px solid #dc3545;
   color: #721c24;
}
</style>
</head>

<body>
   <div class="header">
       <h1>PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
       <div class="subtitle">Sistema di Gestione Produzione - Simone Gatto</div>
       <div class="header-info">
           <div><strong>Data:</strong> <span id="current-date"></span></div>
           <div><strong>Agrume:</strong> <span id="selected-agrume">N/D</span></div>
           <div><strong>Fornitori:</strong> <span id="suppliers-count">0</span></div>
       </div>
       <div style="margin-top: 10px; font-size: 16px;">
           <strong>Generato:</strong> <span id="last-revision"></span>
       </div>
   </div>

   <div id="save-status" class="save-status">
       <span id="save-message"></span>
   </div>

   <div class="controls-section">
       <div class="form-group">
           <label for="tipo-agrume-giornaliero">Tipo di Agrume</label>
           <select class="form-select" id="tipo-agrume-giornaliero" required>
               <option value="">Seleziona il tipo di agrume</option>
               <option value="LIMONE">Limone</option>
               <option value="ARANCIA">Arancia</option>
               <option value="MANDARINO">Mandarino</option>
               <option value="POMPELMO">Pompelmo</option>
               <option value="BERGAMOTTO">Bergamotto</option>
           </select>
       </div>
       
       <div class="form-group">
           <label for="data-lavorazione">Data Lavorazione</label>
           <input type="date" class="form-control" id="data-lavorazione" required>
       </div>
       
       <div>
           <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
               <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
           </button>
           <button type="button" class="btn btn-success" id="rese-button">
               <i class="bi bi-bar-chart-line-fill"></i> Rese
           </button>
           <button type="button" class="btn btn-info" id="salva-programma">
               <i class="bi bi-save"></i> Salva
           </button>
           <button type="button" class="btn btn-info" id="carica-programma">
               <i class="bi bi-folder-open"></i> Carica
           </button>
           <button type="button" class="btn btn-warning" onclick="window.print()">
               <i class="bi bi-printer"></i> Stampa
           </button>
           <button type="button" class="btn btn-danger" id="reset-programma">
               <i class="bi bi-arrow-clockwise"></i> Reset
           </button>
       </div>
   </div>

   <div class="totals-section">
       <div class="total-item">
           <div class="total-value" id="entrata-giornaliera-display">0</div>
           <div class="total-label">Kg Entrata Totale</div>
       </div>
       <div class="total-item">
           <div class="total-value" id="trasformata-totale-display">0</div>
           <div class="total-label">Kg Trasformati</div>
       </div>
       <div class="total-item">
           <div class="total-value" id="giacenza-totale-display">0</div>
           <div class="total-label">Kg Giacenza</div>
       </div>
   </div>

   <div id="combinazioni-section" class="combination-section">
       <h3 style="margin-bottom: 15px; color: #1e3c72;"><i class="bi bi-diagram-3"></i> Selezione Combinazioni Fornitori</h3>
       
       <div class="combination-group" id="combination-group-a">
           <h5><i class="bi bi-droplet"></i> Succo 1ª</h5>
           <select class="form-select" id="combinazione-fornitori-a" multiple="multiple">
               </select>
           <button type="button" class="btn btn-success" id="applica-combinazione-a">
               <i class="bi bi-check-circle"></i> Applica
           </button>
           <button type="button" class="btn btn-warning" id="reset-combinazione-a">
               <i class="bi bi-x-circle"></i> Reset
           </button>
       </div>
       
       <div class="combination-group" id="combination-group-b">
           <h5><i class="bi bi-droplet-fill"></i> Succo 2ª</h5>
           <select class="form-select" id="combinazione-fornitori-b" multiple="multiple">
               </select>
           <button type="button" class="btn btn-success" id="applica-combinazione-b">
               <i class="bi bi-check-circle"></i> Applica
           </button>
           <button type="button" class="btn btn-warning" id="reset-combinazione-b">
               <i class="bi bi-x-circle"></i> Reset
           </button>
       </div>

       <div class="combination-group" id="combination-group-c">
           <h5><i class="bi bi-dash-circle"></i> Torchiato</h5>
           <select class="form-select" id="combinazione-fornitori-c" multiple="multiple">
               </select>
           <button type="button" class="btn btn-success" id="applica-combinazione-c">
               <i class="bi bi-check-circle"></i> Applica
           </button>
           <button type="button" class="btn btn-warning" id="reset-combinazione-c">
               <i class="bi bi-x-circle"></i> Reset
           </button>
       </div>
   </div>

   <div class="suppliers-container" id="suppliers-container">
       </div>

   <div id="summary-section" class="summary-section hidden-field">
       </div>

   <div class="footer">
       <p><strong>Documento generato automaticamente - Sistema di Gestione Produzione Simone Gatto</strong></p>
       <p><strong>Legenda:</strong> (1ª) = Succo 1ª | (2ª) = Succo 2ª | (T) = Torchiato | (Tr) = Trasferimenti</p>
   </div>

   <div id="yields-modal" class="yields-modal">
       <div class="yields-content">
           <div class="yields-header">
               <h2><i class="bi bi-bar-chart-line-fill"></i> Gestione Rese per Agrume</h2>
               <span class="close-yields">&times;</span>
           </div>
           
           <div class="agrume-display">
               <h4 id="agrume-selected">Nessun agrume selezionato</h4>
           </div>
           
           <div class="yields-section">
               <h5><i class="bi bi-droplet"></i> Rese Succo 1ª (%)</h5>
               <table class="yields-table">
                   <thead>
                       <tr>
                           <th>Resa</th>
                           <th>Gen</th>
                           <th>Feb</th>
                           <th>Mar</th>
                           <th>Apr</th>
                           <th>Mag</th>
                           <th>Giu</th>
                           <th>Lug</th>
                           <th>Ago</th>
                           <th>Set</th>
                           <th>Ott</th>
                           <th>Nov</th>
                           <th>Dic</th>
                       </tr>
                   </thead>
                   <tbody>
                       <tr>
                           <td><strong>Succo 1ª (%)</strong></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="1" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="2" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="3" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="4" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="5" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="6" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="7" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="8" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="9" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="10" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="11" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="prima" data-month="12" min="0" max="100" step="0.1"></td>
                       </tr>
                   </tbody>
               </table>
           </div>
           
           <div class="yields-section">
               <h5><i class="bi bi-droplet"></i> Rese Succo 2ª (%)</h5>
               <table class="yields-table">
                   <thead>
                       <tr>
                           <th>Resa</th>
                           <th>Gen</th>
                           <th>Feb</th>
                           <th>Mar</th>
                           <th>Apr</th>
                           <th>Mag</th>
                           <th>Giu</th>
                           <th>Lug</th>
                           <th>Ago</th>
                           <th>Set</th>
                           <th>Ott</th>
                           <th>Nov</th>
                           <th>Dic</th>
                       </tr>
                   </thead>
                   <tbody>
                       <tr>
                           <td><strong>Succo 2ª (%)</strong></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="1" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="2" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="3" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="4" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="5" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="6" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="7" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="8" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="9" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="10" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="11" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="seconda" data-month="12" min="0" max="100" step="0.1"></td>
                       </tr>
                   </tbody>
               </table>
           </div>
           
           <div class="yields-section">
               <h5><i class="bi bi-droplet"></i> Rese Torchiato (%)</h5>
               <table class="yields-table">
                   <thead>
                       <tr>
                           <th>Resa</th>
                           <th>Gen</th>
                           <th>Feb</th>
                           <th>Mar</th>
                           <th>Apr</th>
                           <th>Mag</th>
                           <th>Giu</th>
                           <th>Lug</th>
                           <th>Ago</th>
                           <th>Set</th>
                           <th>Ott</th>
                           <th>Nov</th>
                           <th>Dic</th>
                       </tr>
                   </thead>
                   <tbody>
                       <tr>
                           <td><strong>Torchiato (%)</strong></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="1" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="2" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="3" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="4" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="5" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="6" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="7" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="8" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="9" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="10" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="11" min="0" max="100" step="0.1"></td>
                           <td><input type="number" class="yield-input" data-type="torchiato" data-month="12" min="0" max="100" step="0.1"></td>
                       </tr>
                   </tbody>
               </table>
           </div>
           
           <div class="text-center mt-4">
               <button type="button" class="btn btn-success" id="salva-rese">
                   <i class="bi bi-save"></i> Salva Rese
               </button>
               <button type="button" class="btn btn-warning" id="reset-rese">
                   <i class="bi bi-arrow-clockwise"></i> Reset Valori
               </button>
           </div>
       </div>
   </div>

<script>
$(document).ready(function() {
   let supplierCount = 0;
   let programData = {};

   // Variabili per le combinazioni
   let combinationColors = {
       'prima': 'green',
       'seconda': 'blue',
       'torchiato': 'purple'
   };
   let activeCombinations = {
       'prima': { suppliers: [], colorClass: 'combination-green' },
       'seconda': { suppliers: [], colorClass: 'combination-blue' },
       'torchiato': { suppliers: [], colorClass: 'combination-purple' }
   };

   // Variabili per gestione rese
   let yieldsData = {};

   // Variabili per gestione trasferimenti
   let transferData = {};

   // Definizione varietà per ogni tipo di agrume
   const varietyOptions = {
       'LIMONE': [
           { value: 'VERDELLO', text: 'Verdello' },
           { value: 'FEMMINELLO', text: 'Femminello' },
           { value: 'INTERDONATO', text: 'Interdonato' },
           { value: 'BIANCHETTO', text: 'Bianchetto' },
           { value: 'MONACHELLO', text: 'Monachello' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro (specifica quale)' }
       ],
       'MANDARINO': [
           { value: 'TARD. DI CIACULLI', text: 'Tard. di Ciaculli' },
           { value: 'AVANA', text: 'Avana' },
           { value: 'CLEMENTINO', text: 'Clementino' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro (specifica quale)' }
       ],
       'ARANCIA': [
           { value: 'BIONDA', text: 'Bionda' },
           { value: 'MORO', text: 'Moro' },
           { value: 'SANGUINELLA', text: 'Sanguinella' },
           { value: 'TAROCCO', text: 'Tarocco' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro (specifica quale)' }
       ],
       'BERGAMOTTO': [
           { value: 'FEMMINELLO', text: 'Femminello' },
           { value: 'CASTAGNARO', text: 'Castagnaro' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro (specifica quale)' }
       ],
       'POMPELMO': [
           { value: 'GIALLO', text: 'Giallo' },
           { value: 'ROSA', text: 'Rosa' },
           { value: 'VARIE', text: 'Varie' },
           { value: 'ALTRO', text: 'Altro (specifica quale)' }
       ]
   };

   // Inizializzazione data corrente e ultima revisione
   function initCurrentDate() {
       const today = new Date();
       const formatted = today.toLocaleDateString('it-IT', {
           weekday: 'long',
           year: 'numeric',
           month: 'long',
           day: 'numeric'
       });
       $('#current-date').text(formatted);
       $('#data-lavorazione').val(today.toISOString().split('T')[0]);
       
       updateLastRevision();
   }

   // Aggiorna ultima revisione
   function updateLastRevision() {
       const now = new Date();
       const lastRevision = now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT');
       $('#last-revision').text(lastRevision);
   }

   // Calcolo automatico rese in base al tipo di agrume
   function calculateAutoYields(agrume) {
       const yields = {
           'LIMONE': { prima: 33, seconda: 5, torchiato: 6 },
           'ARANCIA': { prima: 35, seconda: 12, torchiato: 6 },
           'MANDARINO': { prima: 42, seconda: 10, torchiato: 4 },
           'POMPELMO': { prima: 30, seconda: 15, torchiato: 6 },
           'BERGAMOTTO': { prima: 30, seconda: 8, torchiato: 3 }
       };
       return yields[agrume] || { prima: 45, seconda: 10, torchiato: 4 };
   }

   // Crea card fornitore
   function createSupplierCard(index) {
       const agrume = $('#tipo-agrume-giornaliero').val();
       const yields = agrume ? calculateAutoYields(agrume) : { prima: 33, seconda: 5, torchiato: 6 };

       const varietyOptionsHtml = agrume && varietyOptions[agrume] ? 
           varietyOptions[agrume].map(v => `<option value="${v.value}">${v.text}</option>`).join('') : 
           '<option value="">Seleziona prima l\'agrume</option>';

       return `
           <div class="supplier-card" data-supplier-index="${index}">
               <div class="supplier-header">F${index} - <span class="supplier-name">Nuovo Fornitore</span></div>
               
               <div class="form-row">
                   <span class="form-label">Nome Fornitore:</span>
                   <div class="form-input">
                       <select class="nome-fornitore form-select" onchange="updateSupplierName(${index})">
                           <option value="">Seleziona fornitore</option>
                           <option value="ROSSI S.R.L.">ROSSI S.R.L.</option>
                           <option value="VERDI S.P.A.">VERDI S.P.A.</option>
                           <option value="BIANCHI AZ.AGR.">BIANCHI AZ.AGR.</option>
                           <option value="GIALLI FRATELLI">GIALLI FRATELLI</option>
                           <option value="BLU SOC.COOP.">BLU SOC.COOP.</option>
                           <option value="MARRONI AZ.AGR.">MARRONI AZ.AGR.</option>
                           <option value="ALTRO">ALTRO (specifica)</option>
                       </select>
                   </div>
               </div>
               <div class="form-row hidden-field altro-fornitore-input">
                   <span class="form-label">Specifica Altro:</span>
                   <div class="form-input">
                       <input type="text" class="form-control altro-fornitore-text" placeholder="Nome fornitore">
                   </div>
               </div>
               <div class="form-row">
                   <span class="form-label">Quantità (Kg):</span>
                   <div class="form-input">
                       <input type="number" class="form-control quantita-fornitore" min="0" value="0" oninput="calculateSupplierTotals(${index})">
                   </div>
               </div>
               <div class="form-row">
                   <span class="form-label">Varietà:</span>
                   <div class="form-input">
                       <select class="form-select varieta-agrume" onchange="toggleAltroVarieta(${index})">
                           ${varietyOptionsHtml}
                       </select>
                   </div>
               </div>
               <div class="form-row hidden-field altro-varieta-input">
                   <span class="form-label">Specifica Varietà:</span>
                   <div class="form-input">
                       <input type="text" class="form-control altro-varieta-text" placeholder="Specifica varietà">
                   </div>
               </div>
               <div class="form-row">
                   <span class="form-label">Bio/Convenzionale:</span>
                   <div class="form-input">
                       <select class="form-select tipo-produzione" onchange="updateBioStatus(${index})">
                           <option value="CONV">Convenzionale</option>
                           <option value="BIO">Biologico</option>
                       </select>
                   </div>
               </div>
               <div class="form-row">
                   <span class="form-label">Note Fornitore:</span>
                   <div class="form-input">
                       <textarea class="form-control note-fornitore" rows="2"></textarea>
                   </div>
               </div>

               <div class="section-divider"></div>
               
               <div class="form-row">
                   <span class="form-label">Succo 1ª (L):</span>
                   <div class="form-input">
                       <input type="number" class="form-control succo-prima calculated-field" readonly value="0">
                   </div>
               </div>
               <div class="form-row">
                   <span class="form-label">Succo 2ª (L):</span>
                   <div class="form-input">
                       <input type="number" class="form-control succo-seconda calculated-field" readonly value="0">
                   </div>
               </div>
               <div class="form-row">
                   <span class="form-label">Torchiato (L):</span>
                   <div class="form-input">
                       <input type="number" class="form-control torchiato calculated-field" readonly value="0">
                   </div>
               </div>
               <div class="form-row">
                   <span class="form-label">Scarto (Kg):</span>
                   <div class="form-input">
                       <input type="number" class="form-control scarto calculated-field" readonly value="0">
                   </div>
               </div>

               <div class="section-divider"></div>

               <div class="transfer-section">
                   <div class="form-row">
                       <span class="form-label">Succo 1ª Trasferito:</span>
                       <div class="form-input">
                           <input type="number" class="form-control succo-prima-trasferito" min="0" value="0" oninput="calculateSupplierTotals(${index})">
                       </div>
                   </div>
                   <div class="form-row">
                       <span class="form-label">Succo 2ª Trasferito:</span>
                       <div class="form-input">
                           <input type="number" class="form-control succo-seconda-trasferito" min="0" value="0" oninput="calculateSupplierTotals(${index})">
                       </div>
                   </div>
                   <div class="form-row">
                       <span class="form-label">Torchiato Trasferito:</span>
                       <div class="form-input">
                           <input type="number" class="form-control torchiato-trasferito" min="0" value="0" oninput="calculateSupplierTotals(${index})">
                       </div>
                   </div>
                   <button type="button" class="btn btn-sm btn-info w-100 mt-2 aggiungi-trasferimento" data-supplier-index="${index}">
                       <i class="bi bi-arrow-right-square"></i> Dettagli Trasferimento
                   </button>
                   <div class="transfer-details" id="transfer-details-${index}" style="display:none;"></div>
               </div>
               
               <div class="section-divider"></div>

               <div class="form-row">
                   <span class="form-label">Tipo Lavorazione (A):</span>
                   <div class="form-input">
                       <input type="text" class="form-control tipo-lavorazione-a combination-result" readonly value="N/D">
                   </div>
               </div>
               <div class="form-row">
                   <span class="form-label">Tipo Lavorazione (B):</span>
                   <div class="form-input">
                       <input type="text" class="form-control tipo-lavorazione-b combination-result" readonly value="N/D">
                   </div>
               </div>
               <div class="form-row">
                   <span class="form-label">Tipo Lavorazione (C):</span>
                   <div class="form-input">
                       <input type="text" class="form-control tipo-lavorazione-c combination-result" readonly value="N/D">
                   </div>
               </div>
               
               <div class="section-divider"></div>

               <div class="form-row">
                   <span class="form-label">Giacenza (Kg):</span>
                   <div class="form-input">
                       <input type="number" class="form-control giacenza-fornitore auto-sum-field" readonly value="0">
                   </div>
               </div>
               <div class="form-row">
                   <span class="form-label">Note Lavorazione:</span>
                   <div class="form-input">
                       <textarea class="form-control note-lavorazione" rows="2"></textarea>
                   </div>
               </div>
               <div class="text-center mt-3">
                   <button type="button" class="btn btn-danger btn-sm" onclick="removeSupplier(${index})">
                       <i class="bi bi-trash"></i> Rimuovi Fornitore
                   </button>
               </div>
           </div>
       `;
   }

   // Aggiungi fornitore al programma
   function addSupplier() {
       supplierCount++;
       $('#suppliers-container').append(createSupplierCard(supplierCount));
       $('#suppliers-count').text(supplierCount);
       updateSupplierOptions();
       initializeSelect2();

       // Set default yields for the new supplier
       const agrume = $('#tipo-agrume-giornaliero').val();
       if (agrume) {
           const currentMonth = new Date($('#data-lavorazione').val()).getMonth() + 1; // 1-indexed month
           const primaYield = yieldsData[agrume]?.prima[currentMonth] || calculateAutoYields(agrume).prima;
           const secondaYield = yieldsData[agrume]?.seconda[currentMonth] || calculateAutoYields(agrume).seconda;
           const torchiatoYield = yieldsData[agrume]?.torchiato[currentMonth] || calculateAutoYields(agrume).torchiato;

           $(`.supplier-card[data-supplier-index="${supplierCount}"] .resa-prima`).val(primaYield);
           $(`.supplier-card[data-supplier-index="${supplierCount}"] .resa-seconda`).val(secondaYield);
           $(`.supplier-card[data-supplier-index="${supplierCount}"] .resa-torchiato`).val(torchiatoYield);
       }

       calculateOverallTotals();
       updateLastRevision();

       // Add new supplier to all combination dropdowns
       const newOption = new Option(`F${supplierCount} - Nuovo Fornitore`, supplierCount, false, false);
       $('#combinazione-fornitori-a').append(newOption).trigger('change');
       $('#combinazione-fornitori-b').append(newOption).trigger('change');
       $('#combinazione-fornitori-c').append(newOption).trigger('change');

       // Ensure combination section is visible
       $('#combinazioni-section').removeClass('hidden-field');
   }

   // Rimuovi fornitore
   function removeSupplier(index) {
       $(`.supplier-card[data-supplier-index="${index}"]`).remove();
       
       // Update supplierCount and re-index remaining cards
       supplierCount = 0;
       $('#suppliers-container .supplier-card').each(function(i) {
           const newIndex = i + 1;
           $(this).attr('data-supplier-index', newIndex);
           $(this).find('.supplier-header').html(`F${newIndex} - <span class="supplier-name">${$(this).find('.supplier-name').text()}</span>`);
           $(this).find('.quantita-fornitore').attr('oninput', `calculateSupplierTotals(${newIndex})`);
           $(this).find('.succo-prima-trasferito').attr('oninput', `calculateSupplierTotals(${newIndex})`);
           $(this).find('.succo-seconda-trasferito').attr('oninput', `calculateSupplierTotals(${newIndex})`);
           $(this).find('.torchiato-trasferito').attr('oninput', `calculateSupplierTotals(${newIndex})`);
           $(this).find('.aggiungi-trasferimento').attr('data-supplier-index', newIndex);
           $(this).find('.transfer-details').attr('id', `transfer-details-${newIndex}`);
           $(this).find('.btn-danger').attr('onclick', `removeSupplier(${newIndex})`);
           supplierCount++;
       });
       $('#suppliers-count').text(supplierCount);
       updateSupplierOptions();
       calculateOverallTotals();
       updateLastRevision();

       // Remove from combination dropdowns
       $(`#combinazione-fornitori-a option[value="${index}"]`).remove();
       $(`#combinazione-fornitori-b option[value="${index}"]`).remove();
       $(`#combinazione-fornitori-c option[value="${index}"]`).remove();
       
       // Re-trigger change to update selected values visually
       $('#combinazione-fornitori-a, #combinazione-fornitori-b, #combinazione-fornitori-c').trigger('change');

       // Reset supplier card color if it was part of a combination
       for (const comboType in activeCombinations) {
           activeCombinations[comboType].suppliers = activeCombinations[comboType].suppliers.filter(s => s !== index);
           resetSupplierColor(index); // Reset color for the removed supplier
           applyCombinationColors(); // Re-apply colors for remaining combinations
       }
   }

   // Aggiorna nome fornitore nel header della card
   window.updateSupplierName = function(index) {
       const selectElement = $(`.supplier-card[data-supplier-index="${index}"] .nome-fornitore`);
       const selectedValue = selectElement.val();
       const supplierNameSpan = $(`.supplier-card[data-supplier-index="${index}"] .supplier-name`);
       const altroInput = $(`.supplier-card[data-supplier-index="${index}"] .altro-fornitore-input`);
       const altroText = $(`.supplier-card[data-supplier-index="${index}"] .altro-fornitore-text`);

       if (selectedValue === 'ALTRO') {
           altroInput.removeClass('hidden-field');
           altroText.focus();
           supplierNameSpan.text('ALTRO');
           altroText.off('input').on('input', function() {
               supplierNameSpan.text($(this).val() || 'ALTRO');
               updateSupplierOptions(); // Update options when "Altro" text changes
           });
       } else {
           altroInput.addClass('hidden-field');
           supplierNameSpan.text(selectedValue || 'Nuovo Fornitore');
           altroText.off('input');
       }
       updateSupplierOptions();
   };

   // Toggle input "Altro" per varietà
   window.toggleAltroVarieta = function(index) {
       const selectElement = $(`.supplier-card[data-supplier-index="${index}"] .varieta-agrume`);
       const selectedValue = selectElement.val();
       const altroInput = $(`.supplier-card[data-supplier-index="${index}"] .altro-varieta-input`);

       if (selectedValue === 'ALTRO') {
           altroInput.removeClass('hidden-field');
       } else {
           altroInput.addClass('hidden-field');
       }
   };

   // Aggiorna stato Bio/Convenzionale
   window.updateBioStatus = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const tipoProduzioneSelect = card.find('.tipo-produzione');
       const fieldsToColor = card.find('.quantita-fornitore, .succo-prima, .succo-seconda, .torchiato, .scarto');
       const header = card.find('.supplier-header');

       if (tipoProduzioneSelect.val() === 'BIO') {
           fieldsToColor.removeClass('bio-black-field').addClass('bio-red-field');
           header.removeClass('bio-black-text').addClass('bio-red-text');
       } else {
           fieldsToColor.removeClass('bio-red-field').addClass('bio-black-field');
           header.removeClass('bio-red-text').addClass('bio-black-text');
       }
   };

   // Calcolo totali fornitore
   window.calculateSupplierTotals = function(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       const quantita = parseFloat(card.find('.quantita-fornitore').val()) || 0;
       
       const selectedAgrume = $('#tipo-agrume-giornaliero').val();
       const processingDate = $('#data-lavorazione').val();
       const currentMonth = processingDate ? new Date(processingDate).getMonth() + 1 : (new Date().getMonth() + 1);

       const primaYield = yieldsData[selectedAgrume]?.prima[currentMonth] || calculateAutoYields(selectedAgrume).prima;
       const secondaYield = yieldsData[selectedAgrume]?.seconda[currentMonth] || calculateAutoYields(selectedAgrume).seconda;
       const torchiatoYield = yieldsData[selectedAgrume]?.torchiato[currentMonth] || calculateAutoYields(selectedAgrume).torchiato;

       const succoPrima = (quantita * primaYield / 100).toFixed(2);
       const succoSeconda = (quantita * secondaYield / 100).toFixed(2);
       const torchiato = (quantita * torchiatoYield / 100).toFixed(2);
       const scarto = (quantita - succoPrima - succoSeconda - torchiato).toFixed(2);

       card.find('.succo-prima').val(succoPrima);
       card.find('.succo-seconda').val(succoSeconda);
       card.find('.torchiato').val(torchiato);
       card.find('.scarto').val(scarto);

       // Calculate giacenza
       const succoPrimaTrasferito = parseFloat(card.find('.succo-prima-trasferito').val()) || 0;
       const succoSecondaTrasferito = parseFloat(card.find('.succo-seconda-trasferito').val()) || 0;
       const torchiatoTrasferito = parseFloat(card.find('.torchiato-trasferito').val()) || 0;
       
       const giacenza = (quantita - (parseFloat(succoPrima) + succoPrimaTrasferito) - (parseFloat(succoSeconda) + succoSecondaTrasferito) - (parseFloat(torchiato) + torchiatoTrasferito) - parseFloat(scarto)).toFixed(2);
       card.find('.giacenza-fornitore').val(giacenza);

       calculateOverallTotals();
   };

   // Calcolo totali complessivi
   function calculateOverallTotals() {
       let totalEntrata = 0;
       let totalTrasformata = 0;
       let totalGiacenza = 0;

       $('#suppliers-container .supplier-card').each(function() {
           const quantita = parseFloat($(this).find('.quantita-fornitore').val()) || 0;
           const succoPrima = parseFloat($(this).find('.succo-prima').val()) || 0;
           const succoSeconda = parseFloat($(this).find('.succo-seconda').val()) || 0;
           const torchiato = parseFloat($(this).find('.torchiato').val()) || 0;
           const giacenza = parseFloat($(this).find('.giacenza-fornitore').val()) || 0;
           const succoPrimaTrasferito = parseFloat($(this).find('.succo-prima-trasferito').val()) || 0;
           const succoSecondaTrasferito = parseFloat($(this).find('.succo-seconda-trasferito').val()) || 0;
           const torchiatoTrasferito = parseFloat($(this).find('.torchiato-trasferito').val()) || 0;

           totalEntrata += quantita;
           totalTrasformata += (succoPrima + succoSeconda + torchiato + succoPrimaTrasferito + succoSecondaTrasferito + torchiatoTrasferito);
           totalGiacenza += giacenza;
       });

       $('#entrata-giornaliera-display').text(totalEntrata.toFixed(2) + ' Kg');
       $('#trasformata-totale-display').text(totalTrasformata.toFixed(2) + ' Kg');
       $('#giacenza-totale-display').text(totalGiacenza.toFixed(2) + ' Kg');

       generateSummary();
   }

   // Aggiorna opzioni fornitori nei select2 per combinazioni
   function updateSupplierOptions() {
       const supplierOptions = [];
       $('#suppliers-container .supplier-card').each(function() {
           const index = $(this).data('supplier-index');
           const name = $(this).find('.supplier-name').text();
           supplierOptions.push({
               id: index,
               text: `F${index} - ${name}`
           });
       });

       // Clear existing options before adding new ones
       $('#combinazione-fornitori-a').empty().append('<option value="">Seleziona combinazione A</option>');
       $('#combinazione-fornitori-b').empty().append('<option value="">Seleziona combinazione B</option>');
       $('#combinazione-fornitori-c').empty().append('<option value="">Seleziona combinazione C</option>');

       // Add new options
       supplierOptions.forEach(option => {
           $('#combinazione-fornitori-a').append(new Option(option.text, option.id, false, false));
           $('#combinazione-fornitori-b').append(new Option(option.text, option.id, false, false));
           $('#combinazione-fornitori-c').append(new Option(option.text, option.id, false, false));
       });

       // Re-initialize select2 to update with new options
       initializeSelect2();

       // Restore previously selected values for combinations if they still exist
       activeCombinations['prima'].suppliers.forEach(id => {
           $(`#combinazione-fornitori-a option[value="${id}"]`).prop('selected', true);
       });
       activeCombinations['seconda'].suppliers.forEach(id => {
           $(`#combinazione-fornitori-b option[value="${id}"]`).prop('selected', true);
       });
       activeCombinations['torchiato'].suppliers.forEach(id => {
           $(`#combinazione-fornitori-c option[value="${id}"]`).prop('selected', true);
       });

       $('#combinazione-fornitori-a, #combinazione-fornitori-b, #combinazione-fornitori-c').trigger('change');
   }

   // Inizializza Select2
   function initializeSelect2() {
       $('.form-select').select2({
           placeholder: "Seleziona",
           allowClear: true
       });
       $('#combinazione-fornitori-a, #combinazione-fornitori-b, #combinazione-fornitori-c').select2({
           placeholder: "Seleziona fornitori",
           multiple: true,
           allowClear: true
       });
   }

   // Applica combinazione (generalizzata)
   function applyCombination(type) {
       const selectId = `combinazione-fornitori-${type}`;
       const selectedSuppliers = $(`#${selectId}`).val() || [];
       const combinedTypeName = type === 'prima' ? 'Succo 1ª' : (type === 'seconda' ? 'Succo 2ª' : 'Torchiato');

       // Clear previous combination type and color
       activeCombinations[type].suppliers.forEach(index => {
           const card = $(`.supplier-card[data-supplier-index="${index}"]`);
           card.find(`.tipo-lavorazione-${type}`).val('N/D').removeClass(activeCombinations[type].colorClass);
           resetSupplierColor(index);
       });

       activeCombinations[type].suppliers = [];

       // Apply new combination
       selectedSuppliers.forEach(supplierIndex => {
           const card = $(`.supplier-card[data-supplier-index="${supplierIndex}"]`);
           card.find(`.tipo-lavorazione-${type}`).val(combinedTypeName);
           activeCombinations[type].suppliers.push(parseInt(supplierIndex));
       });
       applyCombinationColors();
       updateLastRevision();
   }

   // Reset combinazione (generalizzata)
   function resetCombination(type) {
       $(`#combinazione-fornitori-${type}`).val(null).trigger('change');
       activeCombinations[type].suppliers.forEach(index => {
           $(`.supplier-card[data-supplier-index="${index}"] .tipo-lavorazione-${type}`).val('N/D');
           resetSupplierColor(index);
       });
       activeCombinations[type].suppliers = [];
       applyCombinationColors();
       updateLastRevision();
   }

   // Apply combination colors to supplier cards
   function applyCombinationColors() {
       // First, reset all supplier card colors to default
       $('#suppliers-container .supplier-card').each(function() {
           $(this).removeClass('combination-green combination-blue combination-purple');
           $(this).find('.supplier-header').css('background', '').css('color', '#ffffff'); /* Reset to default */
       });

       // Apply colors based on active combinations
       for (const type in activeCombinations) {
           const colorClass = activeCombinations[type].colorClass;
           const headerColor = combinationColors[type]; // Use specific color name for header

           activeCombinations[type].suppliers.forEach(supplierIndex => {
               const card = $(`.supplier-card[data-supplier-index="${supplierIndex}"]`);
               card.addClass(colorClass);
               
               // Apply specific header color based on the combination type
               if (type === 'prima') {
                   card.find('.supplier-header').css('background-color', '#28a745'); /* Green */
               } else if (type === 'seconda') {
                   card.find('.supplier-header').css('background-color', '#17a2b8'); /* Blue */
               } else if (type === 'torchiato') {
                   card.find('.supplier-header').css('background-color', '#6f42c1'); /* Purple */
               }
           });
       }

       // Set combination group background colors
       $('#combination-group-a').removeClass('combination-green-bg combination-blue-bg combination-purple-bg');
       $('#combination-group-b').removeClass('combination-green-bg combination-blue-bg combination-purple-bg');
       $('#combination-group-c').removeClass('combination-green-bg combination-blue-bg combination-purple-bg');

       if (activeCombinations['prima'].suppliers.length > 0) {
           $('#combination-group-a').addClass('combination-green-bg');
       }
       if (activeCombinations['seconda'].suppliers.length > 0) {
           $('#combination-group-b').addClass('combination-blue-bg');
       }
       if (activeCombinations['torchiato'].suppliers.length > 0) {
           $('#combination-group-c').addClass('combination-purple-bg');
       }
   }

   // Reset supplier card color to default
   function resetSupplierColor(index) {
       const card = $(`.supplier-card[data-supplier-index="${index}"]`);
       card.removeClass('combination-green combination-blue combination-purple');
       card.find('.supplier-header').css('background', '#6c757d').css('color', '#ffffff');
   }

   // Genera riepilogo
   function generateSummary() {
       let summaryHtml = '';
       let totalKgPrima = 0;
       let totalKgSeconda = 0;
       let totalKgTorchiato = 0;
       let totalKgScarto = 0;
       let totalKgTrasferitoPrima = 0;
       let totalKgTrasferitoSeconda = 0;
       let totalKgTrasferitoTorchiato = 0;

       $('#suppliers-container .supplier-card').each(function() {
           const succoPrima = parseFloat($(this).find('.succo-prima').val()) || 0;
           const succoSeconda = parseFloat($(this).find('.succo-seconda').val()) || 0;
           const torchiato = parseFloat($(this).find('.torchiato').val()) || 0;
           const scarto = parseFloat($(this).find('.scarto').val()) || 0;
           const succoPrimaTrasferito = parseFloat($(this).find('.succo-prima-trasferito').val()) || 0;
           const succoSecondaTrasferito = parseFloat($(this).find('.succo-seconda-trasferito').val()) || 0;
           const torchiatoTrasferito = parseFloat($(this).find('.torchiato-trasferito').val()) || 0;

           totalKgPrima += succoPrima;
           totalKgSeconda += succoSeconda;
           totalKgTorchiato += torchiato;
           totalKgScarto += scarto;
           totalKgTrasferitoPrima += succoPrimaTrasferito;
           totalKgTrasferitoSeconda += succoSecondaTrasferito;
           totalKgTrasferitoTorchiato += torchiatoTrasferito;
       });

       summaryHtml += `
           <div class="summary-box">
               <div class="summary-title">Riepilogo Totali</div>
               <div class="summary-item">
                   <span>Totale Succo 1ª Prodotto:</span>
                   <span class="summary-value">${totalKgPrima.toFixed(2)} L</span>
               </div>
               <div class="summary-item">
                   <span>Totale Succo 2ª Prodotto:</span>
                   <span class="summary-value">${totalKgSeconda.toFixed(2)} L</span>
               </div>
               <div class="summary-item">
                   <span>Totale Torchiato Prodotto:</span>
                   <span class="summary-value">${totalKgTorchiato.toFixed(2)} L</span>
               </div>
               <div class="summary-item">
                   <span>Totale Scarto:</span>
                   <span class="summary-value">${totalKgScarto.toFixed(2)} Kg</span>
               </div>
               <hr>
               <div class="summary-item">
                   <span>Totale Succo 1ª Trasferito:</span>
                   <span class="summary-value">${totalKgTrasferitoPrima.toFixed(2)} L</span>
               </div>
               <div class="summary-item">
                   <span>Totale Succo 2ª Trasferito:</span>
                   <span class="summary-value">${totalKgTrasferitoSeconda.toFixed(2)} L</span>
               </div>
               <div class="summary-item">
                   <span>Totale Torchiato Trasferito:</span>
                   <span class="summary-value">${totalKgTrasferitoTorchiato.toFixed(2)} L</span>
               </div>
           </div>
           <div class="summary-box">
               <div class="summary-title">Note Generali</div>
               <textarea class="summary-textarea" id="note-generali" placeholder="Inserisci note generali sul programma..."></textarea>
           </div>
           <div class="summary-box">
               <div class="summary-title">Destinazione Succhi / Torchiato</div>
               <div class="distribution-section">
                   <div class="remaining-qty" id="remaining-prima">Rimanente Succo 1ª: ${totalKgPrima.toFixed(2)} L</div>
                   <div id="distribution-prima"></div>
                   <button type="button" class="btn btn-sm btn-outline-info mt-2" onclick="addDistributionRow('prima')">Aggiungi Dest. 1ª</button>
               </div>
               <div class="distribution-section mt-3">
                   <div class="remaining-qty" id="remaining-seconda">Rimanente Succo 2ª: ${totalKgSeconda.toFixed(2)} L</div>
                   <div id="distribution-seconda"></div>
                   <button type="button" class="btn btn-sm btn-outline-info mt-2" onclick="addDistributionRow('seconda')">Aggiungi Dest. 2ª</button>
               </div>
               <div class="distribution-section mt-3">
                   <div class="remaining-qty" id="remaining-torchiato">Rimanente Torchiato: ${totalKgTorchiato.toFixed(2)} L</div>
                   <div id="distribution-torchiato"></div>
                   <button type="button" class="btn btn-sm btn-outline-info mt-2" onclick="addDistributionRow('torchiato')">Aggiungi Dest. Torchiato</button>
               </div>
           </div>
       `;
       $('#summary-section').html(summaryHtml).removeClass('hidden-field');
       loadDistributionData();
   }

   // Aggiungi riga distribuzione per succhi/torchiato
   window.addDistributionRow = function(type) {
       const container = $(`#distribution-${type}`);
       const rowId = `dist-${type}-${Date.now()}`;
       const rowHtml = `
           <div class="distribution-row" id="${rowId}">
               <input type="text" class="form-control distribution-dest" placeholder="Destinazione">
               <input type="number" class="form-control distribution-qty" min="0" value="0" oninput="calculateRemainingDistribution('${type}')">
               <button type="button" class="btn btn-danger btn-sm" onclick="removeDistributionRow('${rowId}', '${type}')"><i class="bi bi-x"></i></button>
           </div>
       `;
       container.append(rowHtml);
       calculateRemainingDistribution(type);
   }

   // Rimuovi riga distribuzione
   window.removeDistributionRow = function(rowId, type) {
       $(`#${rowId}`).remove();
       calculateRemainingDistribution(type);
   }

   // Calcola rimanente distribuzione
   function calculateRemainingDistribution(type) {
       let totalProduced = 0;
       if (type === 'prima') {
           $('#suppliers-container .supplier-card').each(function() {
               totalProduced += parseFloat($(this).find('.succo-prima').val()) || 0;
           });
       } else if (type === 'seconda') {
           $('#suppliers-container .supplier-card').each(function() {
               totalProduced += parseFloat($(this).find('.succo-seconda').val()) || 0;
           });
       } else if (type === 'torchiato') {
           $('#suppliers-container .supplier-card').each(function() {
               totalProduced += parseFloat($(this).find('.torchiato').val()) || 0;
           });
       }

       let totalDistributed = 0;
       $(`#distribution-${type} .distribution-qty`).each(function() {
           totalDistributed += parseFloat($(this).val()) || 0;
       });

       const remaining = (totalProduced - totalDistributed).toFixed(2);
       $(`#remaining-${type}`).text(`Rimanente ${type === 'prima' ? 'Succo 1ª' : (type === 'seconda' ? 'Succo 2ª' : 'Torchiato')}: ${remaining} L`);
   }

   // Aggiungi dettagli trasferimento (modal o inline)
   $(document).on('click', '.aggiungi-trasferimento', function() {
       const supplierIndex = $(this).data('supplier-index');
       const transferDetailsDiv = $(`#transfer-details-${supplierIndex}`);
       transferDetailsDiv.toggle(); // Toggle visibility

       if (transferDetailsDiv.is(':visible') && transferDetailsDiv.children().length === 0) {
           transferDetailsDiv.append(`
               <div class="transfer-row mt-2">
                   <span class="form-label">Destinazione:</span>
                   <input type="text" class="form-control transfer-destination" placeholder="Destinazione">
               </div>
               <div class="transfer-row">
                   <span class="form-label">Note Trasferimento:</span>
                   <textarea class="form-control transfer-note" rows="1"></textarea>
               </div>
           `);
       }
   });

   // Gestione cambio tipo agrume
   $('#tipo-agrume-giornaliero').on('change', function() {
       const selectedAgrume = $(this).val();
       $('#selected-agrume').text(selectedAgrume || 'N/D');

       // Update variety options for all existing suppliers
       $('#suppliers-container .supplier-card').each(function() {
           const index = $(this).data('supplier-index');
           const varietySelect = $(this).find('.varieta-agrume');
           varietySelect.empty();
           if (selectedAgrume && varietyOptions[selectedAgrume]) {
               varietyOptions[selectedAgrume].forEach(v => {
                   varietySelect.append(new Option(v.text, v.value));
               });
           } else {
               varietySelect.append(new Option('Seleziona prima l\'agrume', ''));
           }
           varietySelect.trigger('change.select2'); // Update select2
       });

       // Update yields for all existing suppliers and recalculate totals
       $('#suppliers-container .supplier-card').each(function() {
           const index = $(this).data('supplier-index');
           calculateSupplierTotals(index);
       });

       // Load yields data for the new agrume
       loadYieldsForAgrume(selectedAgrume);
   });

   // Gestione cambio data lavorazione
   $('#data-lavorazione').on('change', function() {
       const selectedAgrume = $('#tipo-agrume-giornaliero').val();
       if (selectedAgrume) {
           loadYieldsForAgrume(selectedAgrume); // Reload yields based on new date's month
           // Recalculate all supplier totals to apply new yields if month changed
           $('#suppliers-container .supplier-card').each(function() {
               const index = $(this).data('supplier-index');
               calculateSupplierTotals(index);
           });
       }
       updateLastRevision();
   });

   // Event Listener per Rese
   $('#rese-button').on('click', function() {
       const selectedAgrume = $('#tipo-agrume-giornaliero').val();
       if (!selectedAgrume) {
           alert('Seleziona prima un tipo di agrume per gestire le rese.');
           return;
       }
       $('#agrume-selected').text(selectedAgrume);
       loadYieldsForAgrume(selectedAgrume);
       $('#yields-modal').show();
   });

   // Chiudi Modal Rese
   $('.close-yields').on('click', function() {
       $('#yields-modal').hide();
   });

   // Salva Rese
   $('#salva-rese').on('click', function() {
       const agrume = $('#agrume-selected').text();
       if (!yieldsData[agrume]) {
           yieldsData[agrume] = {
               prima: {},
               seconda: {},
               torchiato: {}
           };
       }

       $('.yield-input').each(function() {
           const type = $(this).data('type');
           const month = $(this).data('month');
           const value = parseFloat($(this).val());
           yieldsData[agrume][type][month] = value;
       });
       saveYieldsToLocalStorage();
       $('#yields-modal').hide();
       alert('Rese salvate con successo!');

       // After saving, recalculate all supplier totals with potentially updated yields
       $('#suppliers-container .supplier-card').each(function() {
           const index = $(this).data('supplier-index');
           calculateSupplierTotals(index);
       });
   });

   // Reset Rese nel modal
   $('#reset-rese').on('click', function() {
       if (confirm('Sei sicuro di voler resettare tutti i valori delle rese per questo agrume? Verranno ripristinati i valori di default.')) {
           const agrume = $('#agrume-selected').text();
           delete yieldsData[agrume]; // Remove data for this agrume
           saveYieldsToLocalStorage();
           loadYieldsForAgrume(agrume); // Reload default values
           alert('Rese resettate ai valori di default.');
       }
   });

   // Carica Rese dal Local Storage
   function loadYieldsFromLocalStorage() {
       const storedYields = localStorage.getItem('yieldsData');
       if (storedYields) {
           yieldsData = JSON.parse(storedYields);
       }
   }

   // Salva Rese nel Local Storage
   function saveYieldsToLocalStorage() {
       localStorage.setItem('yieldsData', JSON.stringify(yieldsData));
   }

   // Carica i valori delle rese per l'agrume selezionato nel modal
   function loadYieldsForAgrume(agrume) {
       // Reset all input fields in the modal first
       $('.yield-input').val('');

       if (agrume && yieldsData[agrume]) {
           for (const type in yieldsData[agrume]) {
               for (const month in yieldsData[agrume][type]) {
                   $(`.yield-input[data-type="${type}"][data-month="${month}"]`).val(yieldsData[agrume][type][month]);
               }
           }
       } else if (agrume) {
           // If no custom data, load default auto-calculated values
           const defaultYields = calculateAutoYields(agrume);
           for (let month = 1; month <= 12; month++) {
               $(`.yield-input[data-type="prima"][data-month="${month}"]`).val(defaultYields.prima);
               $(`.yield-input[data-type="seconda"][data-month="${month}"]`).val(defaultYields.seconda);
               $(`.yield-input[data-type="torchiato"][data-month="${month}"]`).val(defaultYields.torchiato);
           }
       }
   }

   // Salva programma con nome su una cartella del computer
   $('#salva-programma').on('click', async function() {
       const agrume = $('#tipo-agrume-giornaliero').val();
       const dataLavorazione = $('#data-lavorazione').val();
       if (!agrume || !dataLavorazione) {
           showSaveStatus('Selezionare tipo di agrume e data di lavorazione.', true);
           return;
       }

       programData = {
           agrume: agrume,
           dataLavorazione: dataLavorazione,
           suppliers: [],
           activeCombinations: activeCombinations,
           generalNotes: $('#note-generali').val(),
           distribution: {
               prima: [],
               seconda: [],
               torchiato: []
           }
       };

       $('#suppliers-container .supplier-card').each(function() {
           const index = $(this).data('supplier-index');
           const isAltroFornitore = $(this).find('.nome-fornitore').val() === 'ALTRO';
           const supplierName = isAltroFornitore ? $(this).find('.altro-fornitore-text').val() : $(this).find('.nome-fornitore').val();
           const isAltroVarieta = $(this).find('.varieta-agrume').val() === 'ALTRO';
           const varietaAgrume = isAltroVarieta ? $(this).find('.altro-varieta-text').val() : $(this).find('.varieta-agrume').val();

           const supplier = {
               index: index,
               nomeFornitore: supplierName,
               quantita: parseFloat($(this).find('.quantita-fornitore').val()) || 0,
               varieta: varietaAgrume,
               tipoProduzione: $(this).find('.tipo-produzione').val(),
               noteFornitore: $(this).find('.note-fornitore').val(),
               succoPrima: parseFloat($(this).find('.succo-prima').val()) || 0,
               succoSeconda: parseFloat($(this).find('.succo-seconda').val()) || 0,
               torchiato: parseFloat($(this).find('.torchiato').val()) || 0,
               scarto: parseFloat($(this).find('.scarto').val()) || 0,
               succoPrimaTrasferito: parseFloat($(this).find('.succo-prima-trasferito').val()) || 0,
               succoSecondaTrasferito: parseFloat($(this).find('.succo-seconda-trasferito').val()) || 0,
               torchiatoTrasferito: parseFloat($(this).find('.torchiato-trasferito').val()) || 0,
               giacenza: parseFloat($(this).find('.giacenza-fornitore').val()) || 0,
               noteLavorazione: $(this).find('.note-lavorazione').val(),
               tipoLavorazioneA: $(this).find('.tipo-lavorazione-a').val(),
               tipoLavorazioneB: $(this).find('.tipo-lavorazione-b').val(),
               tipoLavorazioneC: $(this).find('.tipo-lavorazione-c').val(),
               transferDetails: {} // Store transfer details if entered
           };

           // Collect transfer details
           const transferDetailsDiv = $(this).find('.transfer-details');
           if (transferDetailsDiv.is(':visible')) {
               supplier.transferDetails = {
                   destination: transferDetailsDiv.find('.transfer-destination').val(),
                   note: transferDetailsDiv.find('.transfer-note').val()
               };
           }
           programData.suppliers.push(supplier);
       });

       // Collect distribution data
       programData.distribution.prima = [];
       $('#distribution-prima .distribution-row').each(function() {
           programData.distribution.prima.push({
               destination: $(this).find('.distribution-dest').val(),
               qty: parseFloat($(this).find('.distribution-qty').val()) || 0
           });
       });
       programData.distribution.seconda = [];
       $('#distribution-seconda .distribution-row').each(function() {
           programData.distribution.seconda.push({
               destination: $(this).find('.distribution-dest').val(),
               qty: parseFloat($(this).find('.distribution-qty').val()) || 0
           });
       });
       programData.distribution.torchiato = [];
       $('#distribution-torchiato .distribution-row').each(function() {
           programData.distribution.torchiato.push({
               destination: $(this).find('.distribution-dest').val(),
               qty: parseFloat($(this).find('.distribution-qty').val()) || 0
           });
       });

       try {
           const jsonString = JSON.stringify(programData, null, 2);
           const blob = new Blob([jsonString], { type: 'application/json' });
           
           const fileName = `Programma_${agrume}_${dataLavorazione}.json`;
           
           // Use the File System Access API
           const handle = await window.showSaveFilePicker({
               suggestedName: fileName,
               types: [{
                   description: 'JSON Files',
                   accept: {
                       'application/json': ['.json'],
                   },
               }, ],
           });
           const writableStream = await handle.createWritable();
           await writableStream.write(blob);
           await writableStream.close();

           showSaveStatus('Programma salvato con successo!');
       } catch (error) {
           console.error('Errore durante il salvataggio:', error);
           if (error.name === 'AbortError') {
               showSaveStatus('Salvataggio annullato dall\'utente.', true);
           } else {
               showSaveStatus('Errore durante il salvataggio del programma. Controlla la console per dettagli.', true);
           }
       }
       updateLastRevision();
   });

   // Carica programma da una cartella del computer
   $('#carica-programma').on('click', async function() {
       try {
           const [handle] = await window.showOpenFilePicker({
               types: [{
                   description: 'JSON Files',
                   accept: {
                       'application/json': ['.json'],
                   },
               }, ],
               multiple: false
           });
           const file = await handle.getFile();
           const content = await file.text();
           const loadedProgramData = JSON.parse(content);

           // Reset current program
           resetProgram();

           // Populate header info
           $('#tipo-agrume-giornaliero').val(loadedProgramData.agrume).trigger('change');
           $('#data-lavorazione').val(loadedProgramData.dataLavorazione);
           $('#selected-agrume').text(loadedProgramData.agrume || 'N/D');

           // Populate suppliers
           loadedProgramData.suppliers.forEach(supplier => {
               supplierCount++;
               $('#suppliers-container').append(createSupplierCard(supplierCount));
               const card = $(`.supplier-card[data-supplier-index="${supplierCount}"]`);

               // Populate fields
               if (supplier.nomeFornitore === 'ALTRO' || !['ROSSI S.R.L.', 'VERDI S.P.A.', 'BIANCHI AZ.AGR.', 'GIALLI FRATELLI', 'BLU SOC.COOP.', 'MARRONI AZ.AGR.'].includes(supplier.nomeFornitore)) {
                   card.find('.nome-fornitore').val('ALTRO').trigger('change');
                   card.find('.altro-fornitore-text').val(supplier.nomeFornitore);
                   card.find('.supplier-name').text(supplier.nomeFornitore);
               } else {
                   card.find('.nome-fornitore').val(supplier.nomeFornitore).trigger('change');
                   card.find('.supplier-name').text(supplier.nomeFornitore);
               }
               
               card.find('.quantita-fornitore').val(supplier.quantita);
               
               if (supplier.varieta === 'ALTRO' || !varietyOptions[loadedProgramData.agrume].map(v => v.value).includes(supplier.varieta)) {
                   card.find('.varieta-agrume').val('ALTRO').trigger('change');
                   card.find('.altro-varieta-text').val(supplier.varieta);
               } else {
                   card.find('.varieta-agrume').val(supplier.varieta).trigger('change');
               }

               card.find('.tipo-produzione').val(supplier.tipoProduzione).trigger('change');
               card.find('.note-fornitore').val(supplier.noteFornitore);
               card.find('.succo-prima').val(supplier.succoPrima);
               card.find('.succo-seconda').val(supplier.succoSeconda);
               card.find('.torchiato').val(supplier.torchiato);
               card.find('.scarto').val(supplier.scarto);
               card.find('.succo-prima-trasferito').val(supplier.succoPrimaTrasferito);
               card.find('.succo-seconda-trasferito').val(supplier.succoSecondaTrasferito);
               card.find('.torchiato-trasferito').val(supplier.torchiatoTrasferito);
               card.find('.giacenza-fornitore').val(supplier.giacenza);
               card.find('.note-lavorazione').val(supplier.noteLavorazione);
               card.find('.tipo-lavorazione-a').val(supplier.tipoLavorazioneA);
               card.find('.tipo-lavorazione-b').val(supplier.tipoLavorazioneB);
               card.find('.tipo-lavorazione-c').val(supplier.tipoLavorazioneC);
               
               // Populate transfer details if available
               if (supplier.transferDetails && supplier.transferDetails.destination) {
                   const transferDetailsDiv = card.find('.transfer-details');
                   transferDetailsDiv.show();
                   transferDetailsDiv.html(`
                       <div class="transfer-row mt-2">
                           <span class="form-label">Destinazione:</span>
                           <input type="text" class="form-control transfer-destination" value="${supplier.transferDetails.destination}" placeholder="Destinazione">
                       </div>
                       <div class="transfer-row">
                           <span class="form-label">Note Trasferimento:</span>
                           <textarea class="form-control transfer-note" rows="1">${supplier.transferDetails.note}</textarea>
                       </div>
                   `);
               }
           });
           $('#suppliers-count').text(supplierCount);
           updateSupplierOptions();
           initializeSelect2();
           calculateOverallTotals();

           // Restore active combinations
           if (loadedProgramData.activeCombinations) {
               activeCombinations = loadedProgramData.activeCombinations;
               for (const type in activeCombinations) {
                   activeCombinations[type].suppliers.forEach(id => {
                       $(`#combinazione-fornitori-${type} option[value="${id}"]`).prop('selected', true);
                   });
                   $(`#combinazione-fornitori-${type}`).trigger('change');
               }
               applyCombinationColors();
           }
           
           // Restore general notes
           $('#note-generali').val(loadedProgramData.generalNotes || '');

           // Restore distribution data
           if (loadedProgramData.distribution) {
               loadDistributionData(loadedProgramData.distribution);
           }
           
           showSaveStatus('Programma caricato con successo!');
       } catch (error) {
           console.error('Errore durante il caricamento:', error);
           if (error.name === 'AbortError') {
               showSaveStatus('Caricamento annullato dall\'utente.', true);
           } else {
               showSaveStatus('Errore durante il caricamento del programma. Controlla la console per dettagli.', true);
           }
       }
       updateLastRevision();
   });

   // Helper function to load distribution data
   function loadDistributionData(data = null) {
       // Clear existing distribution rows
       $('#distribution-prima').empty();
       $('#distribution-seconda').empty();
       $('#distribution-torchiato').empty();

       const distributionData = data || programData.distribution;

       if (distributionData && distributionData.prima) {
           distributionData.prima.forEach(item => {
               const container = $(`#distribution-prima`);
               const rowId = `dist-prima-${Date.now()}`;
               const rowHtml = `
                   <div class="distribution-row" id="${rowId}">
                       <input type="text" class="form-control distribution-dest" value="${item.destination}" placeholder="Destinazione">
                       <input type="number" class="form-control distribution-qty" min="0" value="${item.qty}" oninput="calculateRemainingDistribution('prima')">
                       <button type="button" class="btn btn-danger btn-sm" onclick="removeDistributionRow('${rowId}', 'prima')"><i class="bi bi-x"></i></button>
                   </div>
               `;
               container.append(rowHtml);
           });
       }
       if (distributionData && distributionData.seconda) {
           distributionData.seconda.forEach(item => {
               const container = $(`#distribution-seconda`);
               const rowId = `dist-seconda-${Date.now()}`;
               const rowHtml = `
                   <div class="distribution-row" id="${rowId}">
                       <input type="text" class="form-control distribution-dest" value="${item.destination}" placeholder="Destinazione">
                       <input type="number" class="form-control distribution-qty" min="0" value="${item.qty}" oninput="calculateRemainingDistribution('seconda')">
                       <button type="button" class="btn btn-danger btn-sm" onclick="removeDistributionRow('${rowId}', 'seconda')"><i class="bi bi-x"></i></button>
                   </div>
               `;
               container.append(rowHtml);
           });
       }
       if (distributionData && distributionData.torchiato) {
           distributionData.torchiato.forEach(item => {
               const container = $(`#distribution-torchiato`);
               const rowId = `dist-torchiato-${Date.now()}`;
               const rowHtml = `
                   <div class="distribution-row" id="${rowId}">
                       <input type="text" class="form-control distribution-dest" value="${item.destination}" placeholder="Destinazione">
                       <input type="number" class="form-control distribution-qty" min="0" value="${item.qty}" oninput="calculateRemainingDistribution('torchiato')">
                       <button type="button" class="btn btn-danger btn-sm" onclick="removeDistributionRow('${rowId}', 'torchiato')"><i class="bi bi-x"></i></button>
                   </div>
               `;
               container.append(rowHtml);
           });
       }

       calculateRemainingDistribution('prima');
       calculateRemainingDistribution('seconda');
       calculateRemainingDistribution('torchiato');
   }

   // Reset programma completo
   function resetProgram() {
       if (confirm('Sei sicuro di voler resettare il programma? Tutti i dati inseriti verranno cancellati.')) {
           $('#suppliers-container').empty();
           supplierCount = 0;
           $('#suppliers-count').text(0);
           $('#tipo-agrume-giornaliero').val('').trigger('change');
           $('#data-lavorazione').val('');
           $('#selected-agrume').text('N/D');
           $('#entrata-giornaliera-display').text('0 Kg');
           $('#trasformata-totale-display').text('0 Kg');
           $('#giacenza-totale-display').text('0 Kg');
           $('#summary-section').addClass('hidden-field').empty();
           $('#combinazione-fornitori-a').val(null).trigger('change');
           $('#combinazione-fornitori-b').val(null).trigger('change');
           $('#combinazione-fornitori-c').val(null).trigger('change');
           activeCombinations = {
               'prima': { suppliers: [], colorClass: 'combination-green' },
               'seconda': { suppliers: [], colorClass: 'combination-blue' },
               'torchiato': { suppliers: [], colorClass: 'combination-purple' }
           };
           applyCombinationColors(); // Ensure combination backgrounds are reset
           $('#combinazioni-section').removeClass('hidden-field'); // Ensure it's visible by default for new suppliers
           updateLastRevision();
           showSaveStatus('Programma resettato con successo!');

           // Add default 6 suppliers
           for (let i = 0; i < 6; i++) {
               addSupplier();
           }
       }
   }

   // Mostra stato salvataggio
   function showSaveStatus(message, isError = false) {
       const statusDiv = $('#save-status');
       const messageSpan = $('#save-message');
       statusDiv.removeClass('save-success save-error').hide();
       messageSpan.text(message);

       if (isError) {
           statusDiv.addClass('save-error');
       } else {
           statusDiv.addClass('save-success');
       }
       statusDiv.slideDown().delay(3000).slideUp();
   }

   // Event Listeners
   $('#aggiungi-fornitore').on('click', addSupplier);
   $('#reset-programma').on('click', resetProgram);

   $('#applica-combinazione-a').on('click', () => applyCombination('prima'));
   $('#reset-combinazione-a').on('click', () => resetCombination('prima'));
   $('#applica-combinazione-b').on('click', () => applyCombination('seconda'));
   $('#reset-combinazione-b').on('click', () => resetCombination('seconda'));
   $('#applica-combinazione-c').on('click', () => applyCombination('torchiato'));
   $('#reset-combinazione-c').on('click', () => resetCombination('torchiato'));

   // Inizializzazione
   initCurrentDate();
   loadYieldsFromLocalStorage();

   // Add default 6 suppliers on load
   for (let i = 0; i < 6; i++) {
       addSupplier();
   }
});
</script>
</body>
</html>
```
